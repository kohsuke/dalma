<project default="default"
         xmlns:j="jelly:core"
         xmlns:a="jelly:ant"
         xmlns:m="jelly:maven"
         xmlns:deploy="deploy"
         xmlns:define="jelly:define"
         xmlns:dalma="dalma">

  <j:include file="maven.dependency-ex.xml" />
  
  <goal name="site:generate">
    <attainGoal name="multiproject:site" />
  </goal>

  <define:taglib uri="dalma">
    <!--
      copy dependency jars.

      @pom  - pom
      @out  - output directory
      @kind - copy jars that have this value in the property
    -->
    <define:tag name="copy-deps">
      <j:forEach var="lib" items="${pom.artifacts}">
        <j:if test="${lib.dependency.getProperty('dist')==kind}">
          <a:copy todir="${out}" file="${lib.path}" />
          <!--a:echo message="Base  : ${lib.file.parent}"/>
          <a:echo message="File  : ${lib.file.name}"/>
          <a:echo message="Path  : ${lib.path}"/-->
        </j:if>
      </j:forEach>
    </define:tag>
    
    <define:tag name="copy-engine">
      <dalma:copy-deps kind="engine" />

      <!-- copy the engine jar itself -->
      <a:copy todir="${out}">
        <a:fileset dir="." includes="modules/engine/target/*.jar" />
        <a:mapper type="flatten" />
      </a:copy>
    </define:tag>
    
    <!--
       copy module files into ${out}/modules
    -->
    <define:tag name="deploy-modules">
      <!-- this parses module POMs into 'multiprojects'. Somehow I need to do this twice -->
      <attainGoal name="multiproject:projects-init" />
      <m:reactor
        basedir="${maven.multiproject.basedir}"
        banner="Gathering project list"
        includes="${maven.multiproject.includes}"
        excludes="${maven.multiproject.excludes}"
        postProcessing="true"
        collectOnly="true"
        collectionVar="multiprojects"
        ignoreFailures="${maven.multiproject.ignoreFailures}"
      />

      <j:forEach var="p" items="${multiprojects}">
        <a:echo>Processing ${p.artifactId}</a:echo>
        <j:set var="moduleDir" value="${p.file.parentFile}" />
        <j:set var="moduleOut" value="${out}/${moduleDir.name}" />

        <a:mkdir dir="${moduleOut}" />
        <a:copy todir="${moduleOut}">
          <a:fileset dir="${moduleDir}/target" includes="*.jar" />
        </a:copy>
        <dalma:copy-deps pom="${p}" out="${moduleOut}" kind="endpoint" />
      </j:forEach>

      <a:delete dir="${out}/engine" />
    </define:tag>
  </define:taglib>


  <goal name="dist:build"
        description="creates a distribution image">
    <!-- build all modules -->
    <!--j:set var="goal" value="jar:install"/>
    <attainGoal name="multiproject:goal"/-->

    <j:set var="out" value="target/dist" />

    <a:mkdir dir="${out}" />

    <!-- copy the engine jar -->
    <dalma:copy-engine />

    <!-- copy docs -->
    <a:copy todir="${out}" file="${basedir}/LICENSE.txt" />
    <a:copy todir="${out}">
      <a:fileset dir="${basedir}/docs" includes="**/*" />
    </a:copy>

    <!-- deploy each module into the distribution image -->
    <dalma:deploy-modules />

    <!-- copy sample applications -->
    <a:copy todir="${out}">
      <a:fileset dir=".">
        <a:include name="samples/*/build.xml" />
      </a:fileset>
      <a:filterset begintoken="$" endtoken="}">
        <a:filter token="{VERSION" value="${pom.currentVersion}" />
      </a:filterset>
    </a:copy>
    <a:copy todir="${out}">
      <a:fileset dir=".">
        <a:include name="samples/*/project.xml" />
        <a:include name="samples/*/*.txt" />
        <a:include name="samples/*/src/**/*" />
      </a:fileset>
    </a:copy>

    <!-- build binary archive files -->
    <a:mkdir dir="${maven.dist.dir}" />
    <j:set var="prefix" value="dalma-${pom.currentVersion}" />
    <a:zip zipfile="${maven.dist.dir}/${prefix}.zip">
      <a:zipfileset prefix="${prefix}" dir="${out}" />
    </a:zip>
    <a:tar tarfile="${maven.dist.dir}/${prefix}.tar.gz" compression="gzip" longfile="gnu">
      <a:tarfileset prefix="${prefix}" dir="${out}" />
    </a:tar>


    <!-- build source bundle -->
    <a:mkdir dir="target/src-dist" />
    <a:copy todir="target/src-dir">
      <a:fileset dir="${basedir}">
        <a:exclude name="target/**/*" />
        <a:include name="**/project.xml" />
        <a:include name="**/maven.xml" />
        <a:include name="**/project.properties" />
        <a:include name="**/src/**/*" />
        <a:exclude name="**/target" />
        <a:exclude name="**/experiments" />
      </a:fileset>
    </a:copy>
    <a:zip zipfile="${maven.dist.dir}/${prefix}-src.zip">
      <a:zipfileset prefix="${prefix}" dir="target/src-dir" />
    </a:zip>
    <a:tar tarfile="${maven.dist.dir}/${prefix}-src.tar.gz" compression="gzip" longfile="gnu">
      <a:tarfileset prefix="${prefix}" dir="target/src-dir" />
    </a:tar>
  </goal>

  <preGoal name="javanet:dist">
    <j:set var="maven.javanet.release.folder" value="/main${maven.javanet.base.folder}" />
    <j:set var="maven.final.name" value="dalma-${pom.currentVersion}" />
    <attainGoal name="dist:container" />
    <m:reactor basedir="modules" includes="webui/project.xml" goals="war" />
  </preGoal>
  
  <postGoal name="javanet:dist">
    <!-- upload container -->
    <javaNetUpload projectName="${maven.javanet.project}"
      toFile="/dalmacon${maven.javanet.base.folder}/dalmacon-${pom.currentVersion}.zip"
      fromFile="target/distributions/dalmacon-${pom.currentVersion}.zip"
      description="Dalma container ver.${pom.currentVersion}"
      overwrite="yes"
      fileStatus="draft"
    />
    <!-- upload war -->
    <javaNetUpload projectName="${maven.javanet.project}"
      toFile="/webui${maven.javanet.base.folder}/dalma-webui-${pom.currentVersion}.war"
      fromFile="modules/webui/target/dalma.war"
      description="Dalma Web UI ver.${pom.currentVersion}"
      overwrite="yes"
      fileStatus="draft"
    />
  </postGoal>
  
  <goal name="javanet:deploy"
        description="deploy each module into java.net">
    <attainGoal name="multiproject:projects-init" />
    <m:reactor
      basedir="${maven.multiproject.basedir}"
      includes="${maven.multiproject.includes}"
      excludes="${maven.multiproject.excludes}"
      goals="javanet:-deploy-each"
    />
  </goal>
  
  <goal name="javanet:-deploy-each">
    <!-- default way to deploy would be 'jar' -->
    <attainGoal name="javanet:deploy-jar" />
  </goal>

  <goal name="multiproject:clean">
    <attainGoal name="multiproject:projects-init" />
    <m:reactor
      basedir="${maven.multiproject.basedir}"
      includes="${maven.multiproject.includes}"
      excludes="${maven.multiproject.excludes}"
      goals="clean"
    />
  </goal>

  <goal name="dist:container"
        description="creates container distribution image">
    <!-- build all modules -->
    <!--attainGoal name="multiproject:install"/> until I debug this build -->
    <!--m:reactor basedir="${basedir}"
               includes="modules/container/project.xml"
               goals="jar"
               postProcessing="false"
               ignoreFailures="false"/> ditto -->
  
    <j:set var="out" value="target/dist-container" />
    <j:set var="prefix" value="dalmacon-${pom.currentVersion}" />
    
    <a:mkdir dir="${out}" />
    
    <a:copy todir="${out}/bin">
      <a:fileset dir="modules/container/src/script" includes="*.sh, *.bat" />
    </a:copy>
    <dalma:copy-engine out="${out}/bin" />
    
    <a:mkdir dir="${out}/lib"/>
    <a:echo file="${out}/lib/readme.txt">Jar files in this directory will be made available to all workflow applications</a:echo>
    
    <a:mkdir dir="${out}/apps"/>
    <a:echo file="${out}/lib/readme.txt">Each directory or .dar file in this directory will become a workflow application</a:echo>
    
    <a:mkdir dir="${out}/modules" />
    <dalma:deploy-modules out="${out}/modules" />
    <a:echo file="${out}/modules/readme.txt">jar files in module directories (modules/*/*.jar) are made available to all workflow applications</a:echo>
    
    <j:set var="maven.dist.dir" value="${maven.build.dir}/distributions" />
    <a:zip zipfile="${maven.dist.dir}/${prefix}.zip">
      <a:zipfileset prefix="${prefix}" dir="target/dist-container" />
    </a:zip>
    <a:tar tarfile="${maven.dist.dir}/${prefix}.tar.gz" compression="gzip" longfile="gnu">
      <a:tarfileset prefix="${prefix}" dir="target/dist-container" />
    </a:tar>
  </goal>
  
  
</project>